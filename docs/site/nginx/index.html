<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Webserver Config - REDA</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  <link href="../css/extra.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Webserver Config";
    var mkdocs_page_input_path = "nginx.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> REDA</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">Webserver Config</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#configuring-webserver-using-nginx">Configuring webserver using NGINX</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#protected-areas">Protected areas</a></li>
        
            <li><a class="toctree-l3" href="#development-vagrant-machine">Development (Vagrant Machine)</a></li>
        
            <li><a class="toctree-l3" href="#production">Production</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">API</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../api/api/">Getting Started</a>
                </li>
                <li class="">
                    
    <span class="caption-text">Authentication</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../api/user/signup/">Sign Up</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/user/signup-confirmation/">Sign Up Confirmation</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/user/signin/">Sign In</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/user/profile/">Profile</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/user/update-profile/">Update Profile</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/user/request-recover/">Request Password Recover</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/user/change-recover-password/">Change Password</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Resources</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../api/resources/resources-list/">Generic List</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/resources/resources-month/">This month list</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/resources/resources-recent/">Recent</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/resources/resources-highlight/">Highlights</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/resources/resources-related/">Related</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/resources/resources-search/">Search</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/resources/resources-details/">Details</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/resources/resources-comments/">Resource Comments</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/resources/resources-newupdate/">Create or Update</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/resources/resources-asyncValidate/">Async validation</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/resources/resources-setHighlight/">Set Highlight</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/resources/resources-setFavorite/">Set Favorite</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/resources/resources-setRating/">Set Rating</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/resources/resources-setApproved/">Moderation</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/resources/resources-undoApproved/">Undo Moderation</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/resources/resources-delete/">Delete One or Collection</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Scripts (Operation Proposals)</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../api/scripts/search/">Search</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/scripts/resource-scripts/">Resource Scripts</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/scripts/single-details/">Script Details</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/scripts/user-scripts/">User Scripts from Resource</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/scripts/createUpdate-list/">Create or Update List</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/scripts/createUpdate-single/">Create or Update one</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/scripts/scripts-setApproved/">Moderation</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/scripts/scripts-undoApproved/">Undo Moderation</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/scripts/delete/">Delete One or Collection</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Applications</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../api/apps/apps-list/">Generic List</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/apps/apps-month/">This month list</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/apps/search/">Search</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/apps/details/">Details</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/apps/create-update/">Create or Update</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/apps/apps-setApproved/">Moderation</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/apps/apps-undoApproved/">Undo Moderation</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/apps/delete/">Delete One or Collection</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Tools</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../api/tools/tools-list/">Generic List</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/tools/tools-month/">This month list</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/tools/search/">Search</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/tools/details/">Details</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/tools/create-update/">Create or Update</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/tools/tools-setApproved/">Moderation</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/tools/tools-undoApproved/">Undo Moderation</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/tools/delete/">Delete One or Collection</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Comments</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../api/comments/list/">List</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/comments/create-update/">Add New</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/comments/pending/">Get pending</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/comments/check-badwords/">Has Bad Words</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/comments/approved/">Moderation</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/comments/delete/">Delete</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Terms</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../api/terms/list/">List</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/terms/create-update/">Create or update</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/terms/delete/">Delete</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Taxonomies</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../api/taxs/list/">List</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/taxs/search/">Search</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/taxs/details/">Details</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/taxs/terms/">Terms</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Terms relationships</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../api/relationships/list/">List</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/relationships/create-update/">Create or update</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/relationships/delete/">Delete</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">News</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../api/news/list/">List</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/news/details/">Details</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/news/create-update/">Create or update</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/news/delete/">Delete</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Contacts</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../api/contacts/list/">List</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/contacts/resource-contacts/">Resource contacts</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/contacts/create/">Create</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../api/contacts/mark-read/">Mark as read</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Approval Messages</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../api/messages/list/">List</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Feedback</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../api/feedback/send/">Send form data</a>
                </li>
    </ul>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">REDA</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Webserver Config</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="configuring-webserver-using-nginx">Configuring webserver using NGINX</h1>
<p>Since this application was developed using NodeJS as the backend technology, the best solution to provide all the static files and redirect the user to the correct paths of the server was NGINX, since this can work as a proxy between the several entry points.
Two configuration environments were used: <strong>Development</strong> and <strong>Production</strong>.</p>
<h2 id="protected-areas">Protected areas</h2>
<p>It is possible to configure protected areas with server authentication without using any API. A tool used with REDA for the testing was <code>htpasswd</code>. For this, just need to run:</p>
<pre><code>htpasswd -c /var/www/domain.com/public_html/.htpasswd username
</code></pre>

<p>When you run the above command, it will prompt you for a password for the provided username, and then create the file .htpasswd in the folder you specified. If you already have a pre-existing password file, you can omit the -c flag. You can use the -D flag to remove the specified user from a password file.</p>
<p>To set protection for an area, set:</p>
<pre><code>location / {
  ...
  auth_basic &quot;Restricted&quot;;
  auth_basic_user_file /var/www/reda.com/public_html/.htpasswd;
  ...
}
</code></pre>

<h2 id="development-vagrant-machine">Development (Vagrant Machine)</h2>
<p>As for the development environment, there are two configuration options, one when using the server-side rendering, and other when not using server-side rendering. In both cases, if you are using a server with Gulp or other than the NodeJS server. Check the comments in the following code:</p>
<pre><code>server {
  listen                *:80;
  server_name           reda.dev www.reda.dev;
  client_max_body_size 150m;

  root /var/www/reda/public;
  index  index.html index.htm index.php;

  access_log            /var/log/nginx/reda.access.log;
  error_log             /var/log/nginx/reda.error.log;


# Comment these if not using server rendering
  location /config/{
    root /var/www/reda/public;
    autoindex on;
  }

  location /assets {
    alias  /var/www/reda/.tmp/assets;
    autoindex on;
  }

# Comment these if using server rendering
  location / {
    root  /var/www/reda/public;
    index index.html;
    try_files $uri $uri/ /index.html;
  }

# Set location to / if using server render
  location /api {
    proxy_pass          http://127.0.0.1:3000;
    proxy_read_timeout  600s;
    proxy_connect_timeout  600s;
    proxy_redirect  off;
    proxy_set_header        Host $host;
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;


  }
  sendfile off;
}
</code></pre>

<h2 id="production">Production</h2>
<p>For the production environment there are some things to have in mind.
In the begining, the app was not server-side rendered, so there was a need to test for the <strong>index.html</strong> file:</p>
<pre><code>location ~ /(\.|index.html){
    root /var/www/reda.com/public_html/dist;
    try_files $uri $uri/ /index.html;
    auth_basic &quot;Restricted&quot;;
    auth_basic_user_file /var/www/reda.com/public_html/.htpasswd;
}
</code></pre>

<p>During the staging, the website was blocked to external users, so there was necessary to protect the website using a "Restricted" access with <em>htpasswd</em>. The same was for NGINX Status, that was being used by the <em>Keymetrics</em> platform to monitor the server:</p>
<pre><code>location /nginx_status {
    stub_status on;
    access_log off;
    allow 83.240.154.150;
    auth_basic &quot;Restricted&quot;;
    auth_basic_user_file /var/www/reda.com/public_html/.htpasswd;
 }
</code></pre>

<p>One vulnerability that can lead to an memory leak is DDOS. In order to avoid this, the best solution is to make use of NGINX, since it can act as a firewall. In this case, it is necessary to limit the request processing rate with the <em>ngx_http_limit_req_module</em> module.
First, we set the parameters for a shared memory zone:</p>
<p><code>limit_req_zone $binary_remote_addr zone=one:10m rate=5r/s</code></p>
<p>Then, inside of the locations that we want to limit, it is necessary to add the following code:</p>
<pre><code>location / {
        ...
        limit_req zone=one burst=5 nodelay;
        ...
}
</code></pre>

<p>With this configuration, it is possible to limit this location to a 5 requests per second, and queue no more than 5 requests in stack. With the <code>nodelay</code>, the exceeding requests are handled as fast as possible, without waiting for the next stack to be available.</p>
<p>This is the final configuration:</p>
<pre><code>limit_req_zone $binary_remote_addr zone=one:10m rate=5r/s

server {
  listen *:80;
  server_name reda.azores.gov.pt www.reda.azores.gov.pt &lt;INTRANET SERVER IP ADDRESS&gt;;
  client_max_body_size 60m;

  access_log      /var/log/nginx/reda.com.access.log;
  error_log       /var/log/nginx/reda.com.error.log;


  #API Documentation
  location /documentation {
          alias /var/www/reda.com/public_html/docs/site;
          auth_basic &quot;Restricted&quot;;
          auth_basic_user_file /var/www/reda.com/public_html/.htpasswd;
  }

  #Give nginx status for Keymetrics
  location /nginx_status {
          stub_status on;
          access_log off;
          allow 83.240.154.150;
          auth_basic &quot;Restricted&quot;;
          auth_basic_user_file /var/www/reda.com/public_html/.htpasswd;
  }

  #Scripts, styles, graphics, etc
  location /assets {
          alias /var/www/reda.com/public_html/dist/assets;
          expires                 1M;
  }

  #App config
  location /config {
          alias /var/www/reda.com/public_html/dist/config;
  }

  #Backend config
  location / {
          proxy_pass      http://127.0.0.1:3000;
          proxy_read_timeout      600s;
          proxy_connect_timeout   600s;
          proxy_redirect          off;
          proxy_set_header        Host $host;
          proxy_set_header        X-Real-IP $remote_addr;
          proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  #API route
  location /api {
          proxy_pass      http://127.0.0.1:3000;
          proxy_read_timeout      600s;
          proxy_connect_timeout   600s;
          proxy_redirect          off;
          proxy_set_header        Host $host;
          proxy_set_header        X-Real-IP $remote_addr;
          proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  #SEO files
  location ~* /(google|robots|sitemap).*.(html|txt|xml)$ {
          root /var/www/reda.com/public_html/public/SEO;
  }
}
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../api/api/" class="btn btn-neutral float-right" title="Getting Started">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href=".." class="btn btn-neutral" title="Home"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href=".." style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../api/api/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
